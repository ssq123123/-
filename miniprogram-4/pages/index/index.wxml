<!--pages/index/index.wxml-->
<view class="container" style="width: 744rpx; display: flex; box-sizing: border-box">
<!-- è‡ªåŠ¨æŠ½æ°´çŠ¶æ€æç¤º -->
<view class="water-status card" wx:if="{{autoWaterEnabled}}">
    <text>ğŸ”¥ è‡ªåŠ¨æŠ½æ°´ä¸­ å‰©ä½™{{autoWaterSettings.remainingRounds}}å±€ å·²æŠ½{{totalAutoWater}}åˆ†</text>
  </view>
  <!-- ä¸ŠåŠåŒºï¼šä½ç½®å’Œåˆ†æ•°æ˜¾ç¤º -->
  <view class="card" style="width: 691rpx; height: 572rpx; display: block; box-sizing: border-box; position: relative; left: 11rpx; top: 14rpx">
    <view class="flex-row between">
      <view class="countdown-box">ç‰Œå±€å‰©ä½™æ—¶é—´ï¼š{{countdown}}</view>
      <view class="game-number">ç¬¬{{gameNumber}}å±€</view>
    </view>
    <view class="text-center bold mb-20"></view>
    
    <view wx:if="{{!positionSet}}" class="flex-col center">
      <text class="mb-20">è¯·é€‰æ‹©æ‚¨æŠ½ä¸­çš„ä½ç½®ï¼š</text>
      <button class="btn btn-settings" style="width: 95%; margin-top: 10rpx; margin-bottom: 20rpx;" bindtap="showSettings">âš™ï¸ åŸºç¡€è®¾ç½®</button>
      <view class="flex-row">
        <button class="btn btn-primary" bindtap="setPosition" data-position="east" style="width: 281rpx; display: block; box-sizing: border-box; left: 0rpx; top: 0rpx">ä¸œ</button>
        <button class="btn btn-primary" bindtap="setPosition" data-position="south" style="width: 302rpx; height: 54rpx; display: block; box-sizing: border-box; left: 0rpx; top: 0rpx">å—</button>
      </view>
      <view class="flex-row">
        <button class="btn btn-primary" bindtap="setPosition" data-position="west" style="width: 283rpx; height: 54rpx; display: block; box-sizing: border-box; left: 2rpx; top: 0rpx">è¥¿</button>
        <button class="btn btn-primary" bindtap="setPosition" data-position="north" style="width: 306rpx; height: 54rpx; display: block; box-sizing: border-box; left: 2rpx; top: 0rpx; position: relative">åŒ—</button>
      </view>
    </view>
    
    <view wx:else class="flex-col">
      <view class="flex-row center mb-20">
      </view>
      
      <view class="flex-row center mb-10">
        <view class="flex-col center" style="width: 25%;">
          <text>{{positions.north}}</text>
          <text class="score">{{scores.north}}</text>
          <text class="stats-text">
            {{formattedSelfWinTimes.north}}æœªè‡ªæ‘¸
          </text>
          <text class="stats-text">ç´¯è®¡ç :{{totalCodes.north}}</text>
        </view>
      </view>
      
      <view class="flex-row center mb-10">
        <view class="flex-col center" style="width: 25%;">
          <text>{{positions.west}}</text>
          <text class="score">{{scores.west}}</text>
          <text class="stats-text">
            {{formattedSelfWinTimes.west}}æœªè‡ªæ‘¸
          </text>
          <text class="stats-text">ç´¯è®¡ç :{{totalCodes.west}}</text>
        </view>
        <view class="flex-col center" style="width: 25%;">
          <text>{{positions.east}}</text>
          <text class="score">{{scores.east}}</text>
          <text class="stats-text">
            {{formattedSelfWinTimes.east}}æœªè‡ªæ‘¸
          </text>
          <text class="stats-text">ç´¯è®¡ç :{{totalCodes.east}}</text>
        </view>
      </view>
      
      <view class="flex-row center">
        <view class="flex-col center" style="width: 25%;">
          <text>{{positions.south}}</text>
          <text class="score">{{scores.south}}</text>
          <text class="stats-text">
            {{formattedSelfWinTimes.south}}æœªè‡ªæ‘¸
          </text>
          <text class="stats-text">ç´¯è®¡ç :{{totalCodes.south}}</text>
        </view>
      </view>
    </view>
  </view>
  
  <!-- ä¸‹åŠåŒºï¼šæ“ä½œæŒ‰é’®å’Œæ¶ˆæ¯è®°å½• -->
  <view class="card" wx:if="{{positionSet}}">
    <view class="flex-row center mb-20">
      <button class="btn btn-secondary" bindtap="resetGame">é‡æ–°å¼€å§‹</button>
      <button class="btn btn-secondary" bindtap="showAutoWaterSettings">æŠ½æ°´è®¾ç½®</button>
      <switch checked="{{autoWaterEnabled}}" bindchange="toggleAutoWater" />
    </view>

    <view class="flex-row" style="flex-wrap: wrap;">
      <button class="btn btn-primary" style="width: 45%;" 
              wx:for="{{['east','south','west','north']}}" wx:key="index"
              bindtap="showActionModal" data-target="{{item}}">
        {{positions[item]}}å®¶æ“ä½œ
      </button>
    </view>
  </view>
  
  <!-- æ¶ˆæ¯è®°å½•åŒºåŸŸ -->
  <view class="card log-container" wx:if="{{positionSet}}">
    <view class="log-header">
      <text class="bold">æ“ä½œè®°å½•</text>
      <button class="btn-scroll" bindtap="scrollToBottom">â†“ å›åˆ°åº•éƒ¨</button>
    </view>
    <scroll-view 
      scroll-y 
      style="height: 350rpx; font-size: {{settings.fontSize}}rpx;" 
      scroll-top="{{scrollTop}}"
      scroll-with-animation
      bindscroll="onScroll"
    >
      <view wx:for="{{messageLog}}" wx:key="index" class="log-item">
        <text>{{item}}</text>
      </view>
      <view id="anchor"></view>
    </scroll-view>
  </view>
  
  <!-- æ¨¡æ€æ¡†ç»„ä»¶ -->
  <score-modal 
    id="actionModal" 
    bind:confirm="handleAction" 
    bind:cancel="hideAllModals"
  />
  <score-modal 
    id="numberModal" 
    bind:confirm="handleNumberConfirm" 
    bind:cancel="hideAllModals"
    type="number"
  />
  <score-modal 
    id="playerModal" 
    bind:confirm="handlePlayerConfirm" 
    bind:cancel="hideAllModals"
    type="player"
  />
  
  <!-- è®¾ç½®æ¨¡æ€æ¡† -->
  <modal class="settings-modal" hidden="{{!showSettingsModal}}" bindcancel="hideSettings">
    <view class="modal-title">åŸºç¡€è®¾ç½®</view>
    <form bindsubmit="saveSettings">
      <view class="setting-item">
        <text>æŠ½æ°´æ‰£åˆ†æ•°ï¼š</text>
        <input 
          type="number" 
          name="waterValue" 
          value="{{settings.waterValue}}" 
          placeholder="é»˜è®¤2" 
        />
      </view>
      <view class="setting-item">
        <text>åŸºç¡€åˆ†æ•°ï¼š</text>
        <input 
          type="number" 
          name="baseScore" 
          value="{{settings.baseScore}}" 
          placeholder="é»˜è®¤100" 
        />
      </view>
      <view class="setting-item">
        <text>è®°å½•å­—ä½“å¤§å°ï¼š</text>
        <slider 
          name="fontSize"
          value="{{settings.fontSize}}" 
          min="01" 
          max="40" 
          show-value 
          bindchange="onFontSizeChange"
        />
      </view>
      <!-- æ·»åŠ æäº¤æŒ‰é’® -->
      <button form-type="submit">æˆ‘æ‰æ˜¯ç¡®å®š</button>
    </form>
  </modal>

  <!-- è‡ªåŠ¨æŠ½æ°´è®¾ç½®æ¨¡æ€æ¡† -->
  <modal class="settings-modal" hidden="{{!showAutoWaterSettingsModal}}" bindcancel="hideAutoWaterSettings">
    <view class="modal-title">ğŸšï¸ è‡ªåŠ¨æŠ½æ°´è®¾ç½®</view>
    <form bindsubmit="saveAutoWaterSettings">
      <view class="setting-item">
        <text>æ€»æŠ½æ°´å±€æ•°ï¼š</text>
        <input 
          type="number" 
          name="totalRounds" 
          value="{{autoWaterSettings.totalRounds}}" 
          placeholder="è¯·è¾“å…¥æ•°å­—"
        />
      </view>
      <view class="setting-item">
        <text>æ¯å±€æŠ½åˆ†æ•°ï¼š</text>
        <input 
          type="number" 
          name="waterPerRound" 
          value="{{autoWaterSettings.waterPerRound}}" 
          placeholder="é»˜è®¤2åˆ†"
        />
      </view>
      <button form-type="submit" class="btn-confirm">âœ… ä¿å­˜</button>
    </form>
  </modal>
</view>